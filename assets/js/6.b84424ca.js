(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{188:function(t,a,s){"use strict";s.r(a);var n=s(0),e=Object(n.a)({},function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"移动端js模拟截屏生成图片并下载功能的实现方案-踩坑过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#移动端js模拟截屏生成图片并下载功能的实现方案-踩坑过程","aria-hidden":"true"}},[t._v("#")]),t._v(" 移动端js模拟截屏生成图片并下载功能的实现方案+踩坑过程")]),t._v(" "),s("h3",{attrs:{id:"一-项目中有需求如下："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一-项目中有需求如下：","aria-hidden":"true"}},[t._v("#")]),t._v(" 一. 项目中有需求如下：")]),t._v(" "),s("p",[t._v("将营业日报生成图片下载至用户手机保存")]),t._v(" "),s("h3",{attrs:{id:"二-踩坑思路："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二-踩坑思路：","aria-hidden":"true"}},[t._v("#")]),t._v(" 二. 踩坑思路：")]),t._v(" "),s("ol",[s("li",[t._v("首先，因为用的是第三方的app（钉钉）内嵌webview开发，所以无法拿到截屏的api（而且需要生成的日报超出一个屏幕范围，截屏也麻烦）")]),t._v(" "),s("li",[t._v("所以，自然想到了使用第三方工具"),s("a",{attrs:{href:"https://github.com/niklasvh/html2canvas",target:"_blank",rel:"noopener noreferrer"}},[t._v("canvas2html"),s("OutboundLink")],1),t._v("，将页面中指定范围的dom转换为canvas")]),t._v(" "),s("li",[t._v("随后使用canvas的api"),s("code",[t._v("toDataUrl")]),t._v("获得base64格式的图片数据")]),t._v(" "),s("li",[t._v("此时试着直接用a标签下载")])]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[t._v("`"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("a")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("href")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("base64Url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("download")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("name.jpg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("a")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("`\n")])])]),s("ol",{attrs:{start:"5"}},[s("li",[t._v("实际证明该方法移动端失效，提示图片下载失败，因为移动端无法直接下载base64格式的图片（据说pc端，chrome可以直接下载，其他浏览器貌似也有兼容写法，有意者可自行验证）")]),t._v(" "),s("li",[t._v("现在只能先将图片传输至后端保存，随后使用服务器地址下载")]),t._v(" "),s("li",[t._v("为了方便后端处理，我们这里不直接上传base64格式的数据，先将base64转换成blob，再模拟一个表单对象，将blob放进去，使用post提交给后端")]),t._v(" "),s("li",[t._v("拿到服务器地址后，再来尝试a标签下载")]),t._v(" "),s("li",[t._v("这里分两种情况，如果图片地址和项目同源，根据网上的说法，点击a标签应该能直接下载成功了，这里没有验证过")]),t._v(" "),s("li",[t._v("我这里因为图片存到了非同源的服务器，所以点击a标签后，无法自动下载，会转跳到默认浏览器打开图片，随后可以长按下载，这里体验就不好了")]),t._v(" "),s("li",[t._v("所以，最后放弃了a标签的方案，变为添加一个弹出层，展示该图片，提示用户长按下载，至此比较完美的实现了该功能")])]),t._v(" "),s("h3",{attrs:{id:"三-实现流程："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三-实现流程：","aria-hidden":"true"}},[t._v("#")]),t._v(" 三. 实现流程：")]),t._v(" "),s("p",[t._v("html2canvas将页面转换为canvas -> canvas转换dataURL -> base64ToBlob（dataUrl转换为2进制文件流） -> new FormData，将blob放置入该表单对象 -> post请求发送至后端保存图片 -> 后端返回图片地址 -> 使用线上地址展示图片 -> 用户长按保存图片")]),t._v(" "),s("h3",{attrs:{id:"四-下面逐步说明："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四-下面逐步说明：","aria-hidden":"true"}},[t._v("#")]),t._v(" 四. 下面逐步说明：")]),t._v(" "),s("h5",{attrs:{id:"_4-1-html2canvas"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-html2canvas","aria-hidden":"true"}},[t._v("#")]),t._v(" 4.1 html2canvas")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 安装")]),t._v("\nnpm install html2canvas "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("save\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 引入")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Html2canvas "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'html2canvas'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html2canvas "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Html2canvas"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("html2canvas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("querySelector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'#id'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("canvas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// todo...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h5",{attrs:{id:"_4-2-canvas转换dataurl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-canvas转换dataurl","aria-hidden":"true"}},[t._v("#")]),t._v(" 4.2 canvas转换dataURL")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" dataUrl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" canvas"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toDataURL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'image/jpeg'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h5",{attrs:{id:"_4-3-base64toblob"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-base64toblob","aria-hidden":"true"}},[t._v("#")]),t._v(" 4.3 base64ToBlob")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * base64转blob\n * @param {String} code base64个数数据\n * @return {undefined}\n * @author xxx\n */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("base64ToBlob")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("code")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" parts "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("split")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("';base64,'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" contentType "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" parts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("split")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("':'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" raw "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("atob")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" rawLength "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" raw"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" uInt8Array "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Uint8Array")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rawLength"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" rawLength"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uInt8Array"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" raw"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("charCodeAt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Blob")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("uInt8Array"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" contentType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'file_'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.jpg'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" blob "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("base64ToBlob")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataUrl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h5",{attrs:{id:"_4-3-模拟formdata并提交"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-模拟formdata并提交","aria-hidden":"true"}},[t._v("#")]),t._v(" 4.3 模拟formData并提交")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 新建formData")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" formData "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FormData")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将blob存入")]),t._v("\nformData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'file'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" blob"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("此处因为使用的是vue，所以用的axios，提交的时候要注意"),s("code",[t._v("content-type")])]),t._v(" "),s("p",[t._v("注意："),s("em",[t._v("创建请求的时候需要新建axios实例去请求，不要使用import进来的axios，不然content-type修改会不成功")])]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" axios "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'axios'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建新的axios实例")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" instance "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" axios"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置content-type为false就行了")]),t._v("\ninstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("defaults"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("post"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这里特别注意，创建请求的时候，使用这个新创建的实例去进行请求，而不要使用原来的axios")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("instance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'POST'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" formData\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("res")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// todo...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h5",{attrs:{id:"_4-4-使用返回的服务器地址展示图片，让用户长按保存"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-使用返回的服务器地址展示图片，让用户长按保存","aria-hidden":"true"}},[t._v("#")]),t._v(" 4.4 使用返回的服务器地址展示图片，让用户长按保存")]),t._v(" "),s("p",[t._v("这里就不用说什么了，自己创建一个遮罩层去实现就行了")]),t._v(" "),s("h3",{attrs:{id:"五-优化点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#五-优化点","aria-hidden":"true"}},[t._v("#")]),t._v(" 五. 优化点")]),t._v(" "),s("ol",[s("li",[t._v("因为canvas2html -> 发起请求之间需要走过的步骤比较多，而且如果转换的dom比较复杂，中间的处理事件会比较久，所以在这段时间中要做好相应的loading处理；不然用户点击后，可能会看到1s左右的空窗期，而页面什么提示也没有")]),t._v(" "),s("li",[t._v("生成图片的按钮要做好连续点击限制，避免用户频繁触发")])]),t._v(" "),s("hr"),t._v(" "),s("p",[t._v("以上，功能就全部实现，虽然无法实现点击直接下载，但是也在条件允许的范围内，实现比较好的用户体验了")]),t._v(" "),s("hr"),t._v(" "),s("h3",{attrs:{id:"六-最后说一下在ios上面碰到的情况"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#六-最后说一下在ios上面碰到的情况","aria-hidden":"true"}},[t._v("#")]),t._v(" 六. 最后说一下在ios上面碰到的情况")]),t._v(" "),s("p",[t._v("这个方案在android上面一直测试的比较顺利，但是在ios上面出现过一些疑问")]),t._v(" "),s("p",[t._v("主要就是"),s("code",[t._v("canvas.toDataUrl()")]),t._v("这个api失效")]),t._v(" "),s("p",[t._v("当时android顺利调通，在ios上测试的时候，发现js运行到"),s("code",[t._v("canvas.toDataUrl()")]),t._v("就停止了，没有返回值也没有什么错误提示")]),t._v(" "),s("p",[s("strong",[t._v("最后发现是自己添加的水印效果导致在ios执行"),s("code",[t._v("canvas.toDataUrl()")]),t._v("的时候无响应（canvas画出水印，转换base64，添加到父级backgroung-image的实现方式），改变了水印实现方式就正常运行了")])]),t._v(" "),s("p",[t._v("下面把整整一天的踩坑过程写下，给各位参考：")]),t._v(" "),s("p",[t._v("刚开始怀疑html2canvas转化出来的canvas有问题，网上看了很多提问，包括github上面html2canvas的issue，有说可能是html2canvas版本问题的，有说可能是canvas画出的图片过大，导致"),s("code",[t._v("canvas.toDataUrl()")]),t._v("在ios上运行被系统强行阻止的各种说法，经过测试，都无法解决现在的问题")]),t._v(" "),s("p",[t._v("虽然最后证实了不是上述的问题，但还是将测试结果写下")]),t._v(" "),s("h5",{attrs:{id:"_1-html2canvas版本问题："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-html2canvas版本问题：","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. html2canvas版本问题：")]),t._v(" "),s("p",[t._v("npm默认安装的是"),s("code",[t._v('"html2canvas": "^1.0.0-alpha.12"')]),t._v("这个alpha版本")]),t._v(" "),s("p",[t._v("随后我测试过最后的正式release版本，"),s("code",[t._v("v0.4.1")]),t._v("，证实可以正常运行，但是碰到的无法转换超出屏幕部分的dom，和转换的图片模糊的问题要花太多精力去解决，而且作者说了在旧版本有太多的bug，建议使用新的版本，所以最后放弃了旧版本的尝试")]),t._v(" "),s("h5",{attrs:{id:"_2-canvas画出的图片过大，导致canvas-todataurl-在ios上运行被系统强行阻止"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-canvas画出的图片过大，导致canvas-todataurl-在ios上运行被系统强行阻止","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. canvas画出的图片过大，导致"),s("code",[t._v("canvas.toDataUrl()")]),t._v("在ios上运行被系统强行阻止")]),t._v(" "),s("p",[t._v("我转换出来的图片大小在200k左右(用的'image/jpeg'的类型)，没查到网上说的这个极限到底在哪里")]),t._v(" "),s("p",[t._v("当时用自己新建的canvas重新压缩了图片，压缩到只有1kb的时候都如法正常运行"),s("code",[t._v("canvas.toDataUrl()")]),t._v("，就基本排除这个问题了")])])},[],!1,null,null,null);a.default=e.exports}}]);