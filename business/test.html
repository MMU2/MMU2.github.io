<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>移动端js模拟截屏生成图片并下载功能的实现方案+踩坑过程 | 小p的个人主页</title>
    <meta name="description" content="Just playing around">
    
    
    <link rel="preload" href="/assets/css/0.styles.67eddd8a.css" as="style"><link rel="preload" href="/assets/js/app.1a268dc6.js" as="script"><link rel="preload" href="/assets/js/2.5d3236fc.js" as="script"><link rel="preload" href="/assets/js/6.b84424ca.js" as="script"><link rel="prefetch" href="/assets/js/3.86a0bb38.js"><link rel="prefetch" href="/assets/js/4.622e581c.js"><link rel="prefetch" href="/assets/js/5.4fc31c80.js"><link rel="prefetch" href="/assets/js/7.0e305066.js"><link rel="prefetch" href="/assets/js/8.94e442cc.js"><link rel="prefetch" href="/assets/js/9.1e167e13.js">
    <link rel="stylesheet" href="/assets/css/0.styles.67eddd8a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小p的个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">技术整理</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/business/test.html" class="nav-link router-link-exact-active router-link-active">业务相关</a></li><li class="dropdown-item"><!----> <a href="/plantform/test.html" class="nav-link">平台兼容性</a></li><li class="dropdown-item"><!----> <a href="/error/test.html" class="nav-link">异常处理</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="https://www.github.com/codeteenager" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">技术整理</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/business/test.html" class="nav-link router-link-exact-active router-link-active">业务相关</a></li><li class="dropdown-item"><!----> <a href="/plantform/test.html" class="nav-link">平台兼容性</a></li><li class="dropdown-item"><!----> <a href="/error/test.html" class="nav-link">异常处理</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="https://www.github.com/codeteenager" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/business/test.html" class="active sidebar-link">移动端js模拟截屏生成图片并下载功能的实现方案+踩坑过程</a><ul class="sidebar-sub-headers"></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="移动端js模拟截屏生成图片并下载功能的实现方案-踩坑过程"><a href="#移动端js模拟截屏生成图片并下载功能的实现方案-踩坑过程" aria-hidden="true" class="header-anchor">#</a> 移动端js模拟截屏生成图片并下载功能的实现方案+踩坑过程</h1> <h3 id="一-项目中有需求如下："><a href="#一-项目中有需求如下：" aria-hidden="true" class="header-anchor">#</a> 一. 项目中有需求如下：</h3> <p>将营业日报生成图片下载至用户手机保存</p> <h3 id="二-踩坑思路："><a href="#二-踩坑思路：" aria-hidden="true" class="header-anchor">#</a> 二. 踩坑思路：</h3> <ol><li>首先，因为用的是第三方的app（钉钉）内嵌webview开发，所以无法拿到截屏的api（而且需要生成的日报超出一个屏幕范围，截屏也麻烦）</li> <li>所以，自然想到了使用第三方工具<a href="https://github.com/niklasvh/html2canvas" target="_blank" rel="noopener noreferrer">canvas2html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，将页面中指定范围的dom转换为canvas</li> <li>随后使用canvas的api<code>toDataUrl</code>获得base64格式的图片数据</li> <li>此时试着直接用a标签下载</li></ol> <div class="language-html extra-class"><pre class="language-html"><code>`<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>base64Url<span class="token punctuation">&quot;</span></span> <span class="token attr-name">download</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>`
</code></pre></div><ol start="5"><li>实际证明该方法移动端失效，提示图片下载失败，因为移动端无法直接下载base64格式的图片（据说pc端，chrome可以直接下载，其他浏览器貌似也有兼容写法，有意者可自行验证）</li> <li>现在只能先将图片传输至后端保存，随后使用服务器地址下载</li> <li>为了方便后端处理，我们这里不直接上传base64格式的数据，先将base64转换成blob，再模拟一个表单对象，将blob放进去，使用post提交给后端</li> <li>拿到服务器地址后，再来尝试a标签下载</li> <li>这里分两种情况，如果图片地址和项目同源，根据网上的说法，点击a标签应该能直接下载成功了，这里没有验证过</li> <li>我这里因为图片存到了非同源的服务器，所以点击a标签后，无法自动下载，会转跳到默认浏览器打开图片，随后可以长按下载，这里体验就不好了</li> <li>所以，最后放弃了a标签的方案，变为添加一个弹出层，展示该图片，提示用户长按下载，至此比较完美的实现了该功能</li></ol> <h3 id="三-实现流程："><a href="#三-实现流程：" aria-hidden="true" class="header-anchor">#</a> 三. 实现流程：</h3> <p>html2canvas将页面转换为canvas -&gt; canvas转换dataURL -&gt; base64ToBlob（dataUrl转换为2进制文件流） -&gt; new FormData，将blob放置入该表单对象 -&gt; post请求发送至后端保存图片 -&gt; 后端返回图片地址 -&gt; 使用线上地址展示图片 -&gt; 用户长按保存图片</p> <h3 id="四-下面逐步说明："><a href="#四-下面逐步说明：" aria-hidden="true" class="header-anchor">#</a> 四. 下面逐步说明：</h3> <h5 id="_4-1-html2canvas"><a href="#_4-1-html2canvas" aria-hidden="true" class="header-anchor">#</a> 4.1 html2canvas</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 安装</span>
npm install html2canvas <span class="token operator">--</span>save

<span class="token comment">// 引入</span>
<span class="token keyword">import</span> Html2canvas <span class="token keyword">from</span> <span class="token string">'html2canvas'</span><span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>html2canvas <span class="token operator">=</span> Html2canvas<span class="token punctuation">;</span>

<span class="token comment">// 使用</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">html2canvas</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">canvas</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="_4-2-canvas转换dataurl"><a href="#_4-2-canvas转换dataurl" aria-hidden="true" class="header-anchor">#</a> 4.2 canvas转换dataURL</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> dataUrl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">'image/jpeg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_4-3-base64toblob"><a href="#_4-3-base64toblob" aria-hidden="true" class="header-anchor">#</a> 4.3 base64ToBlob</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * base64转blob
 * @param {String} code base64个数数据
 * @return {undefined}
 * @author xxx
 */</span>
<span class="token function">base64ToBlob</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> parts <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';base64,'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> contentType <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> raw <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">atob</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> rawLength <span class="token operator">=</span> raw<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">let</span> uInt8Array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>rawLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rawLength<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uInt8Array<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> raw<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>uInt8Array<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> contentType<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'file_'</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> blob <span class="token operator">=</span> <span class="token function">base64ToBlob</span><span class="token punctuation">(</span>dataUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_4-3-模拟formdata并提交"><a href="#_4-3-模拟formdata并提交" aria-hidden="true" class="header-anchor">#</a> 4.3 模拟formData并提交</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 新建formData</span>
<span class="token keyword">let</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 将blob存入</span>
formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>此处因为使用的是vue，所以用的axios，提交的时候要注意<code>content-type</code></p> <p>注意：<em>创建请求的时候需要新建axios实例去请求，不要使用import进来的axios，不然content-type修改会不成功</em></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>
<span class="token comment">// 创建新的axios实例</span>
<span class="token keyword">let</span> instance <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置content-type为false就行了</span>
instance<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>post<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">// 这里特别注意，创建请求的时候，使用这个新创建的实例去进行请求，而不要使用原来的axios</span>
<span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> formData
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="_4-4-使用返回的服务器地址展示图片，让用户长按保存"><a href="#_4-4-使用返回的服务器地址展示图片，让用户长按保存" aria-hidden="true" class="header-anchor">#</a> 4.4 使用返回的服务器地址展示图片，让用户长按保存</h5> <p>这里就不用说什么了，自己创建一个遮罩层去实现就行了</p> <h3 id="五-优化点"><a href="#五-优化点" aria-hidden="true" class="header-anchor">#</a> 五. 优化点</h3> <ol><li>因为canvas2html -&gt; 发起请求之间需要走过的步骤比较多，而且如果转换的dom比较复杂，中间的处理事件会比较久，所以在这段时间中要做好相应的loading处理；不然用户点击后，可能会看到1s左右的空窗期，而页面什么提示也没有</li> <li>生成图片的按钮要做好连续点击限制，避免用户频繁触发</li></ol> <hr> <p>以上，功能就全部实现，虽然无法实现点击直接下载，但是也在条件允许的范围内，实现比较好的用户体验了</p> <hr> <h3 id="六-最后说一下在ios上面碰到的情况"><a href="#六-最后说一下在ios上面碰到的情况" aria-hidden="true" class="header-anchor">#</a> 六. 最后说一下在ios上面碰到的情况</h3> <p>这个方案在android上面一直测试的比较顺利，但是在ios上面出现过一些疑问</p> <p>主要就是<code>canvas.toDataUrl()</code>这个api失效</p> <p>当时android顺利调通，在ios上测试的时候，发现js运行到<code>canvas.toDataUrl()</code>就停止了，没有返回值也没有什么错误提示</p> <p><strong>最后发现是自己添加的水印效果导致在ios执行<code>canvas.toDataUrl()</code>的时候无响应（canvas画出水印，转换base64，添加到父级backgroung-image的实现方式），改变了水印实现方式就正常运行了</strong></p> <p>下面把整整一天的踩坑过程写下，给各位参考：</p> <p>刚开始怀疑html2canvas转化出来的canvas有问题，网上看了很多提问，包括github上面html2canvas的issue，有说可能是html2canvas版本问题的，有说可能是canvas画出的图片过大，导致<code>canvas.toDataUrl()</code>在ios上运行被系统强行阻止的各种说法，经过测试，都无法解决现在的问题</p> <p>虽然最后证实了不是上述的问题，但还是将测试结果写下</p> <h5 id="_1-html2canvas版本问题："><a href="#_1-html2canvas版本问题：" aria-hidden="true" class="header-anchor">#</a> 1. html2canvas版本问题：</h5> <p>npm默认安装的是<code>&quot;html2canvas&quot;: &quot;^1.0.0-alpha.12&quot;</code>这个alpha版本</p> <p>随后我测试过最后的正式release版本，<code>v0.4.1</code>，证实可以正常运行，但是碰到的无法转换超出屏幕部分的dom，和转换的图片模糊的问题要花太多精力去解决，而且作者说了在旧版本有太多的bug，建议使用新的版本，所以最后放弃了旧版本的尝试</p> <h5 id="_2-canvas画出的图片过大，导致canvas-todataurl-在ios上运行被系统强行阻止"><a href="#_2-canvas画出的图片过大，导致canvas-todataurl-在ios上运行被系统强行阻止" aria-hidden="true" class="header-anchor">#</a> 2. canvas画出的图片过大，导致<code>canvas.toDataUrl()</code>在ios上运行被系统强行阻止</h5> <p>我转换出来的图片大小在200k左右(用的'image/jpeg'的类型)，没查到网上说的这个极限到底在哪里</p> <p>当时用自己新建的canvas重新压缩了图片，压缩到只有1kb的时候都如法正常运行<code>canvas.toDataUrl()</code>，就基本排除这个问题了</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">5/11/2019, 4:01:25 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1a268dc6.js" defer></script><script src="/assets/js/2.5d3236fc.js" defer></script><script src="/assets/js/6.b84424ca.js" defer></script>
  </body>
</html>
